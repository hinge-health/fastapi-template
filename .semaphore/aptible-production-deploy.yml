version: v1.0
name: production-deploy
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Docker tag latest
    dependencies: []
    task:
      secrets:
        - name: aws-ecr-write
      prologue:
        commands:
          - sudo pip install awscli
          - checkout
      jobs:
        - name: Docker build and tag latest
          commands:
            - make ecr-login
            - make docker-build
            - make docker-tag-latest
  - name: Deploy
    dependencies: ['Docker tag latest']
    task:
      env_vars:
        - name: ENVIRONMENT
          value: hinge-prod
        - name: APTIBLE_ROBOT_EMAIL
          value: robot@hingehealth.com
        - name: NEW_RELIC_APP_ID
          value: '{{ template service id }}'
      secrets:
        - name: semaphoreci-id-rsa
        - name: aws-ecr-read
        - name: aptible-robot-password
        - name: new-relic-rest-api-key
      prologue:
        commands:
          - chmod 0600 ~/.keys/*
          - ssh-add ~/.keys/*
          - checkout
          - ssh-keyscan -H beta.aptible.com >> ~/.ssh/known_hosts
          - sudo apt-get install libu2f-host0 u2f-host -y
          - wget https://omnibus-aptible-toolbelt.s3.amazonaws.com/aptible/omnibus-aptible-toolbelt/master/217/pkg/aptible-toolbelt_0.16.7%2B20200812001454~ubuntu.16.04-1_amd64.deb
          - sudo dpkg -i aptible-toolbelt_0.16.7+20200812001454~ubuntu.16.04-1_amd64.deb
      jobs:
      - name: Deploy
        commands:
          - make aptible-login
          - make aptible-deploy
          - make notify-new-relic-of-deploy
